<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0b74de" />
    <meta name="description" content="Track trip expenses with automatic FX conversion" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="TripX" />
    <title>Trip Expense Tracker</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="icons/icon-180.png" />
    <link rel="stylesheet" href="styles.css" />
    <!-- Tesseract.js for offline receipt OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
    <!-- App header -->
    <header class="app-header">
        <h1>âœˆï¸ Trip Expense Tracker</h1>
        <span id="onlineStatus" class="status-badge online" title="Connection status">â— Online</span>
    </header>

    <!-- Trip selector -->
    <div class="trip-bar">
        <label for="tripSelector"><strong>Trip:</strong></label>
        <select id="tripSelector" aria-label="Select trip"></select>
        <button id="newTripBtn" type="button" class="btn btn-outline btn-sm" title="Create a new trip">+ New</button>
        <button id="renameTripBtn" type="button" class="btn btn-ghost btn-sm" title="Rename current trip">âœï¸</button>
        <button id="deleteTripBtn" type="button" class="btn danger-btn btn-sm" title="Delete current trip">ğŸ—‘ï¸</button>
    </div>

    <!-- Live FX rates -->
    <div id="fxRatesBar" class="fx-rates-bar">
        <span class="fx-rates-label">ğŸ’± Rates:</span>
        <span id="fxRatesChips" class="fx-rates-chips">
            <span class="muted">Loadingâ€¦</span>
        </span>
    </div>

    <!-- Tab navigation -->
    <nav class="tab-nav" role="tablist" aria-label="Main sections">
        <button class="tab-btn active" data-page="expense" role="tab" aria-selected="true">
            <span class="tab-icon">ğŸ’³</span> Add Expense
        </button>
        <button class="tab-btn" data-page="summary" role="tab" aria-selected="false">
            <span class="tab-icon">ğŸ“Š</span> Summary
        </button>
        <button class="tab-btn" data-page="settings" role="tab" aria-selected="false">
            <span class="tab-icon">âš™ï¸</span> Settings
        </button>
    </nav>

    <!-- ==================== PAGE: Add Expense ==================== -->
    <section id="page-expense" class="page active" role="tabpanel">
        <div class="box card-elevated">
            <h2>Add Expense</h2>
            <form id="expenseForm">
                <div class="form-group full-width">
                    <label for="expensePhoto">ğŸ“· Scan receipt (optional)</label>
                    <div class="photo-capture">
                        <input id="expensePhoto" type="file" accept="image/*" />
                        <div id="photoPreview" class="photo-preview"></div>
                    </div>
                    <div id="ocrStatus" class="ocr-status" hidden>
                        <span class="ocr-spinner"></span> <span id="ocrStatusText">Scanning receiptâ€¦</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="date">Date</label>
                    <input id="date" type="date" required />
                </div>
                <div class="form-group">
                    <label for="currency">Currency</label>
                    <select id="currency"></select>
                </div>
                <div class="form-group">
                    <label for="method">Method</label>
                    <select id="method">
                        <option value="credit">ğŸ’³ Credit</option>
                        <option value="cash">ğŸ’µ Cash</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category"></select>
                </div>
                <div class="form-group">
                    <label for="amount">Amount (local)</label>
                    <input id="amount" type="number" step="0.01" min="0" required placeholder="0.00" />
                </div>
                <div class="form-group full-width">
                    <label for="description">Description</label>
                    <textarea id="description" rows="2" placeholder="What was this expense for?"></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-lg">â• Add Expense</button>
                </div>
            </form>
        </div>
    </section>

    <!-- ==================== PAGE: Summary ==================== -->
    <section id="page-summary" class="page" role="tabpanel">
        <div class="box card-elevated">
            <h2>ğŸ“‹ Filters</h2>
            <form id="filterForm">
                <div class="form-group">
                    <label for="startDate">Start date</label>
                    <input id="startDate" type="date" />
                </div>
                <div class="form-group">
                    <label for="endDate">End date</label>
                    <input id="endDate" type="date" />
                </div>
                <div class="form-group">
                    <label for="summaryCurrency">Show in currency</label>
                    <select id="summaryCurrency"></select>
                </div>
                <div class="form-group flex">
                    <button type="submit" class="btn btn-primary">Apply</button>
                    <button type="button" id="resetFilters" class="btn btn-ghost">Reset</button>
                </div>
            </form>
        </div>

        <!-- Grand total card -->
        <div class="box total-card">
            <div class="total-label">Trip Total</div>
            <div class="total-value" id="summaryOutput">â€”</div>
        </div>

        <div class="box card-elevated">
            <h2>By Category</h2>
            <table class="table">
                <thead>
                    <tr><th>Category</th><th>Count</th><th>Total (display currency)</th></tr>
                </thead>
                <tbody id="categorySummaryBody"></tbody>
                <tfoot>
                    <tr><td>All Categories</td><td id="catTotalCount">0</td><td id="catGrandTotal">0</td></tr>
                </tfoot>
            </table>
            <div class="muted">Category totals respect your date range and display currency.</div>
        </div>

        <div class="box card-elevated">
            <h2>Expenses</h2>
            <div class="muted" style="margin-bottom:.5rem;">
                FX source: ğŸŒ Frankfurter &nbsp; ğŸ’µ Cash Batch &nbsp; â³ Pending
            </div>
            <div style="overflow-x:auto;">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Method</th>
                            <th>Local Amount</th>
                            <th>FX Rate</th>
                            <th>Home Amount</th>
                            <th>Description</th>
                            <th>Photo</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTbody"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- ==================== PAGE: Settings ==================== -->
    <section id="page-settings" class="page" role="tabpanel">
        <div class="box card-elevated">
            <h2>âš™ï¸ Settings</h2>
            <form id="settingsForm">
                <div class="form-group">
                    <label for="homeCurrency">Home currency (base)</label>
                    <input id="homeCurrency" placeholder="CAD" required />
                    <span class="field-hint">Your base currency for all conversions</span>
                </div>
                <div class="form-group">
                    <label for="tripCurrencies">Trip currencies (local)</label>
                    <input id="tripCurrencies" placeholder="EUR, GBP" required />
                    <span class="field-hint">Comma-separated currencies used on this trip</span>
                </div>
                <div class="form-group">
                    <label for="ccFee">Credit card fee (%)</label>
                    <input id="ccFee" type="number" step="0.1" min="0" value="2.5" required />
                    <span class="field-hint">Foreign transaction fee applied to credit purchases</span>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">ğŸ’¾ Save Settings</button>
                </div>
            </form>
        </div>

        <div class="box card-elevated">
            <h2>ğŸ·ï¸ Categories</h2>
            <div class="flex" style="margin-bottom:.75rem;">
                <input id="newCategoryName" placeholder="e.g., Meals" aria-label="New category name" />
                <button id="addCategory" type="button" class="btn btn-outline">+ Add category</button>
            </div>
            <table class="table">
                <thead><tr><th>Name</th><th>Used</th><th>Actions</th></tr></thead>
                <tbody id="categoriesTbody"></tbody>
            </table>
            <div class="muted">Delete is blocked if a category is in use. Reassign its expenses first.</div>
        </div>

        <div class="box card-elevated">
            <h2>ğŸ’° Cash Batches</h2>
            <form id="cashForm">
                <div class="form-group">
                    <label for="cashDate">Date bought</label>
                    <input id="cashDate" type="date" required />
                </div>
                <div class="form-group">
                    <label for="cashCurrency">Currency</label>
                    <select id="cashCurrency" required></select>
                </div>
                <div class="form-group">
                    <label for="cashRate">Rate (1 unit â†’ home)</label>
                    <input id="cashRate" type="number" step="0.0001" required placeholder="1.3500" />
                </div>
                <div class="form-group">
                    <label for="cashAmount">Amount (local)</label>
                    <input id="cashAmount" type="number" step="0.01" required placeholder="0.00" />
                </div>
                <div class="form-group">
                    <button class="btn btn-primary">Add Cash Batch</button>
                </div>
            </form>
            <ul id="cashBatchesList" class="cash-list"></ul>
        </div>

        <!-- Backup & Restore -->
        <div class="box card-elevated">
            <h2>ğŸ“¦ Backup &amp; Restore</h2>
            <div class="flex" style="margin-bottom:.75rem; align-items:center;">
                <button id="exportBackupBtn" type="button" class="btn btn-outline">â¬‡ï¸ Export Backup</button>
                <label class="file-upload-label btn btn-ghost" for="importFile">
                    ğŸ“ Choose fileâ€¦
                    <input id="importFile" type="file" accept="application/json" class="sr-only" />
                </label>
                <span id="importFileName" class="muted"></span>
                <button id="importBackupBtn" type="button" class="btn btn-outline">â¬†ï¸ Import</button>
            </div>
            <div class="muted">Export creates a JSON file with all your data. Import will merge or replace existing data.</div>
        </div>
    </section>

    <!-- Photo lightbox overlay -->
    <div id="photoLightbox" class="lightbox-overlay" hidden>
        <div class="lightbox-content">
            <img id="lightboxImg" src="" alt="Expense photo" />
            <button id="lightboxClose" class="btn btn-ghost lightbox-close" type="button">âœ• Close</button>
        </div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast" aria-live="polite"></div>

    <script type="module" src="app.js"></script>
</body>
</html>